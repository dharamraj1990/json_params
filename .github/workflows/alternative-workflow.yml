# Alternative workflow using a more robust change detection script
# This version uses a Python script for better change detection

name: Build and Push Lambda Images to ECR (Alternative)

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Allows manual triggering

env:
  AWS_REGION: us-east-1

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-folders: ${{ steps.changes.outputs.folders }}
      folders-json: ${{ steps.changes.outputs.folders-json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect changed folders
        id: changes
        run: |
          python3 << 'EOF'
          import os
          import json
          import subprocess
          from pathlib import Path

          def get_changed_folders():
              """Detect which lambda function folders have changed."""
              # Get the event type
              event_name = os.environ.get('GITHUB_EVENT_NAME', 'push')
              
              if event_name == 'pull_request':
                  base_sha = os.environ.get('GITHUB_BASE_REF', 'main')
                  head_sha = os.environ.get('GITHUB_SHA')
                  try:
                      result = subprocess.run(
                          ['git', 'diff', '--name-only', f'origin/{base_sha}', head_sha],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                      changed_files = result.stdout.strip().split('\n')
                  except:
                      changed_files = []
              else:
                  # For push events
                  before_sha = os.environ.get('GITHUB_EVENT_BEFORE', 'HEAD~1')
                  after_sha = os.environ.get('GITHUB_SHA', 'HEAD')
                  
                  if before_sha == '0000000000000000000000000000000000000000':
                      # Initial commit - check all folders
                      lambda_dir = Path('lambda-functions')
                      if lambda_dir.exists():
                          folders = [d.name for d in lambda_dir.iterdir() if d.is_dir()]
                          return folders
                      return []
                  
                  try:
                      result = subprocess.run(
                          ['git', 'diff', '--name-only', before_sha, after_sha],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                      changed_files = result.stdout.strip().split('\n')
                  except:
                      changed_files = []

              # Extract unique folder names
              lambda_dir = Path('lambda-functions')
              changed_folders = set()
              
              for file_path in changed_files:
                  if file_path.startswith('lambda-functions/'):
                      parts = file_path.split('/')
                      if len(parts) >= 2:
                          folder_name = parts[1]
                          folder_path = lambda_dir / folder_name
                          if folder_path.exists() and folder_path.is_dir():
                              changed_folders.add(folder_name)

              return sorted(list(changed_folders))

          folders = get_changed_folders()
          
          if folders:
              folders_str = ' '.join(folders)
              folders_json = json.dumps(folders)
              print(f"Changed folders: {folders_str}")
              print(f"::set-output name=folders::{folders_str}")
              print(f"::set-output name=folders-json::{folders_json}")
          else:
              print("No lambda function folders changed")
              print("::set-output name=folders::")
              print("::set-output name=folders-json::[]")
          EOF

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.folders != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: ${{ fromJson(needs.detect-changes.outputs.folders-json) }}
      fail-fast: false
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Read ECR repository mapping
        id: ecr-config
        run: |
          ECR_REPO=$(grep "^${{ matrix.folder }}:" .github/lambda-ecr-mapping.txt | cut -d':' -f2 | xargs)
          
          if [ -z "$ECR_REPO" ]; then
            echo "ERROR: No ECR repository mapping found for folder: ${{ matrix.folder }}"
            exit 1
          fi
          
          FULL_ECR_URI="${{ steps.login-ecr.outputs.registry }}/$ECR_REPO"
          echo "ecr-repo=$ECR_REPO" >> $GITHUB_OUTPUT
          echo "ecr-uri=$FULL_ECR_URI" >> $GITHUB_OUTPUT

      - name: Set image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${{ github.sha }}"
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "tag-latest=latest" >> $GITHUB_OUTPUT
          echo "tag-short=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build Docker image
        working-directory: lambda-functions/${{ matrix.folder }}
        run: |
          docker build \
            -t ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag }} \
            -t ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag-short }} \
            -t ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag-latest }} \
            .

      - name: Push Docker image to ECR
        run: |
          docker push ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag }}
          docker push ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag-short }}
          docker push ${{ steps.ecr-config.outputs.ecr-uri }}:${{ steps.image-tag.outputs.tag-latest }}

      - name: Output image details
        run: |
          echo "‚úÖ Successfully built and pushed: ${{ matrix.folder }}"
          echo "üì¶ ECR: ${{ steps.ecr-config.outputs.ecr-uri }}"
          echo "üè∑Ô∏è  Tags: ${{ steps.image-tag.outputs.tag }}, ${{ steps.image-tag.outputs.tag-short }}, latest"

